<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Online Appointment and Record System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  </head>
  <body>
    <div class="container py-5">
      <h2 class="mb-4 text-center">Online Appointment and Record System</h2>

      <!-- Login / Signup Form -->
      <div class="card mb-4" id="authCard">
        <div class="card-header">Login or First-Time User</div>
        <div class="card-body">
          <form id="authForm">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                class="form-control"
                id="password"
                required
              />
            </div>
            <div class="mb-3">
              <label for="name" class="form-label"
                >Full Name (First-time only)</label
              >
              <input type="text" class="form-control" id="name" />
            </div>
            <button type="submit" class="btn btn-primary">Continue</button>
          </form>
          <div id="authMessage" class="mt-3 text-success"></div>
        </div>
      </div>

      <!-- Dashboard (hidden until logged in) -->
      <div id="dashboard" style="display: none">
        <h4 id="welcomeMsg"></h4>
        <button class="btn btn-secondary mb-4" onclick="logout()">
          Log out
        </button>

        <!-- Booking Form -->
        <div class="card mb-4">
          <div class="card-header">Book an Appointment</div>
          <div class="card-body">
            <form id="bookingForm">
              <div class="mb-3">
                <label for="appointmentDate" class="form-label">Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="appointmentDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="appointmentTime" class="form-label">Time</label>
                <input
                  type="time"
                  class="form-control"
                  id="appointmentTime"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">Book</button>
            </form>
          </div>
        </div>

        <!-- Record Viewer -->
        <div class="card">
          <div class="card-header">Your Prescriptions and Records</div>
          <div class="card-body" id="recordSection">
            <p class="text-muted">Loading records...</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const supabaseUrl = "https://edtmmwdoqzooehxlawae.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdG1td2RvcXpvb2VoeGxhd2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MDQ1NDEsImV4cCI6MjA2NDk4MDU0MX0.GVjxo02VERBIDg3clE2FHS2OLx5qP7st6J8f9Xq5M2s";
      const supabase = supabase.createClient(supabaseUrl, supabaseKey);

      let currentUser = null;

      document
        .getElementById("authForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const name = document.getElementById("name").value;

          const { data: signInData, error: signInError } =
            await supabase.auth.signInWithPassword({ email, password });

          if (signInError) {
            const { data: signUpData, error: signUpError } =
              await supabase.auth.signUp({ email, password });
            if (signUpError) {
              document.getElementById("authMessage").textContent =
                "Error: " + signUpError.message;
              return;
            }
            await supabase
              .from("patients")
              .insert([{ id: signUpData.user.id, name }]);
            document.getElementById("authMessage").textContent =
              "Signed up! Please verify your email.";
          } else {
            document.getElementById("authMessage").textContent = "Logged in!";
          }

          setTimeout(loadDashboard, 1000);
        });

      async function loadDashboard() {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) return;

        currentUser = user;

        const { data: patient } = await supabase
          .from("patients")
          .select("*")
          .eq("id", user.id)
          .single();

        document.getElementById("authCard").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("welcomeMsg").textContent =
          "Welcome, " + patient.name;

        // Load records
        const { data: records, error } = await supabase
          .from("records")
          .select("*")
          .eq("patient_id", user.id);

        const section = document.getElementById("recordSection");
        section.innerHTML = "";
        records.forEach((r) => {
          const div = document.createElement("div");
          div.innerHTML = `<strong>${r.date}</strong>: ${r.prescription}<br>`;
          section.appendChild(div);
        });
      }

      document
        .getElementById("bookingForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const date = document.getElementById("appointmentDate").value;
          const time = document.getElementById("appointmentTime").value;

          // Prevent conflicts
          const { data: conflict } = await supabase
            .from("appointments")
            .select("*")
            .eq("appointment_date", date)
            .eq("appointment_time", time);

          if (conflict.length > 0) {
            alert("Time slot already booked.");
            return;
          }

          await supabase.from("appointments").insert([
            {
              patient_id: currentUser.id,
              appointment_date: date,
              appointment_time: time,
            },
          ]);

          alert("Appointment booked!");
        });

      async function logout() {
        await supabase.auth.signOut();
        location.reload();
      }
    </script>
  </body>
</html>
